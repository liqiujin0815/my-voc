<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ğŸ“˜ æˆ‘çš„å•è¯æœ¬ - å®Œæ•´ç‰ˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fdfdfd;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        .form-row label {
            width: 80px;
            font-weight: 600;
            font-size: 14px;
        }
        input[type="text"], textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        textarea { height: 60px; resize: vertical; }
        .image-upload {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: start;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #fafafa;
            min-height: 100px;
        }
        .image-upload:focus-within {
            border-color: #3498db;
            background: #f0f8ff;
        }
        .image-item {
            position: relative;
            width: 80px;
            height: 80px;
            border: 1px dashed #ccc;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fff;
            font-size: 24px;
            color: #aaa;
            cursor: pointer;
        }
        .image-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .image-item .remove-img {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .paste-hint {
            font-size: 12px;
            color: #999;
            text-align: center;
            width: 100%;
            margin-top: 5px;
        }
        .global-search-box {
            margin: 20px 0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        #globalSearchInput {
            width: 100%;
            max-width: 500px;
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .search-btn {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .search-btn:hover { background-color: #2980b9; }
        .main-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button.primary { background-color: #3498db; color: white; }
        button.primary:hover { background-color: #2980b9; }
        button.success { background-color: #2ecc71; color: white; }
        button.success:hover { background-color: #27ae60; }
        button.warning { background-color: #f39c12; color: white; }
        button.warning:hover { background-color: #e67e22; }
        button.danger { background-color: #e74c3c; color: white; }
        button.danger:hover { background-color: #c0392b; }
        .word-list { list-style: none; padding: 0; }
        .word-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            border-radius: 8px;
            background: #fcfcfc;
            position: relative;
            transition: background-color 0.2s;
        }
        .word-item:hover { background: #f5f9ff; }
        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .word-main { font-weight: bold; color: #2c3e50; font-size: 18px; }
        .word-category {
            display: inline-block;
            padding: 4px 10px;
            background-color: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .word-meaning { font-size: 15px; color: #34495e; margin-bottom: 8px; line-height: 1.5; }
        .word-example { font-size: 14px; color: #555; font-style: italic; padding-left: 10px; border-left: 2px solid #3498db; margin-bottom: 8px; line-height: 1.5; }
        .word-images { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
        .word-images img { max-height: 80px; border-radius: 6px; object-fit: contain; }
        .word-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }
        .word-actions button { padding: 5px 10px; font-size: 12px; }
        .study-mode {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f0f5ff;
            border-radius: 10px;
        }
        #studyWord { font-size: 36px; margin: 20px 0; color: #2c3e50; min-height: 50px; }
        #studyImages { margin: 20px auto; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        #studyImages img { max-height: 150px; border-radius: 8px; object-fit: contain; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .study-info { margin-top: 15px; line-height: 1.6; }
        #studyMeaning, #studyExample { display: none; font-size: 18px; color: #27ae60; }
        #studyExample { font-style: italic; color: #555; margin-top: 10px; }
        .study-controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }
        #qrcode-container {
            width: 256px;
            height: 256px;
            margin: 0 auto 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .close-modal { margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .func-bar { display: flex; justify-content: flex-end; align-items: center; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“˜ æˆ‘çš„å•è¯æœ¬ï¼ˆå®Œæ•´ç‰ˆï¼‰</h1>
        
        <div class="form-section">
            <h2 style="margin:0 0 10px;">ğŸ“ æ·»åŠ æ–°å•è¯</h2>
            <input type="hidden" id="editId" value="" />
            <div class="form-row">
                <label for="wordInput">å•è¯</label>
                <input type="text" id="wordInput" placeholder="è¾“å…¥è‹±æ–‡å•è¯/çŸ­è¯­" />
            </div>
            <div class="form-row">
                <label for="meaningInput">é‡Šä¹‰</label>
                <input type="text" id="meaningInput" placeholder="è¾“å…¥ä¸­æ–‡æ„æ€" />
            </div>
            <div class="form-row">
                <label for="exampleInput">ä¾‹å¥</label>
                <textarea id="exampleInput" placeholder="è¾“å…¥è‹±æ–‡ä¾‹å¥ï¼Œå¯æ¢è¡Œ"></textarea>
            </div>
            <div class="form-row">
                <label>ç±»åˆ«</label>
                <div style="flex:1;">
                    <div class="category-search">
                        <input type="text" id="categorySearch" placeholder="è¾“å…¥ç±»åˆ«ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰" />
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label>å›¾ç‰‡</label>
                <div class="image-upload" id="imageContainer" tabindex="0">
                    <div class="image-item" id="addImageBtn">+</div>
                    <div class="paste-hint">ğŸ’¡ æç¤ºï¼šç‚¹å‡»â€œ+â€ä¸Šä¼  æˆ– ç›´æ¥åœ¨æ­¤åŒºåŸŸæŒ‰ Ctrl+V ç²˜è´´å›¾ç‰‡</div>
                    <input type="file" id="imageInput" accept="image/*" multiple style="display:none;" />
                </div>
            </div>
            <div class="form-row" style="justify-content:flex-end;">
                <button id="cancelEditBtn" style="display:none; margin-right:10px;">å–æ¶ˆ</button>
                <button id="saveWordBtn" class="primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>

        <div class="func-bar">
            <button id="qrcodeBtn" class="primary">ğŸ“± ç”ŸæˆäºŒç»´ç </button>
        </div>

        <div class="global-search-box">
            <input type="text" id="globalSearchInput" placeholder="æœç´¢å•è¯/é‡Šä¹‰/ä¾‹å¥/ç±»åˆ«..." />
            <button id="searchBtn" class="search-btn">ğŸ” æœç´¢</button>
        </div>

        <div class="main-buttons">
            <button id="startStudyBtn" class="primary">ğŸ® å¼€å§‹èƒŒè¯µ</button>
            <button id="exportExcelBtn" class="success">ğŸ“¤ å¯¼å‡ºä¸º Excel</button>
            <button id="importExcelBtn" class="warning">ğŸ“¥ ä» Excel å¯¼å…¥</button>
        </div>

        <div class="study-mode" id="studyMode" style="display:none;">
            <p id="studyWord">ç‚¹å‡»â€œä¸‹ä¸€ä¸ªâ€å¼€å§‹</p>
            <div id="studyImages"></div>
            <div class="study-info">
                <p id="studyMeaning"></p>
                <p id="studyExample"></p>
            </div>
            <div class="study-controls">
                <button id="prevBtn" class="primary">â¬…ï¸ ä¸Šä¸€ä¸ª</button>
                <button id="showMeaningBtn" class="warning">ğŸ‘€ æ˜¾ç¤ºæ„æ€</button>
                <button id="nextBtn" class="primary">ä¸‹ä¸€ä¸ª â¡ï¸</button>
            </div>
        </div>

        <ul id="wordList" class="word-list"></ul>

        <input type="file" id="fileImportInput" accept=".xlsx,.xls" style="display:none;" />
    </div>

    <div class="modal" id="qrcodeModal">
        <div class="modal-content">
            <h3>æ‰«ç å­¦ä¹ </h3>
            <div id="qrcode-container"></div>
            <p>æ‰‹æœºæ‰«ç åŒæ­¥å­¦ä¹ </p>
            <button class="close-modal" id="closeQrcodeBtn">å…³é—­</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // ==================== å­˜å‚¨æ™ºèƒ½åˆ‡æ¢ ====================
        const isFileProtocol = window.location.protocol === 'file:';
        const useIndexedDB = !isFileProtocol;

        let db = null;
        const DB_NAME = 'VocabularyDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'words';
        const LS_KEY = 'vocabulary_words_fallback';

        async function openDB() {
            if (!useIndexedDB) return;
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        async function getAllWords() {
            if (useIndexedDB) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORE_NAME, 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } else {
                const data = localStorage.getItem(LS_KEY);
                return data ? JSON.parse(data) : [];
            }
        }

        async function addWord(wordData) {
            if (useIndexedDB) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORE_NAME, 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.add(wordData);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } else {
                const words = await getAllWords();
                const newId = words.length > 0 ? Math.max(...words.map(w => w.id)) + 1 : 1;
                words.push({ id: newId, ...wordData });
                localStorage.setItem(LS_KEY, JSON.stringify(words));
                return newId;
            }
        }

        async function updateWord(id, wordData) {
            if (useIndexedDB) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORE_NAME, 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.put({ ...wordData, id });
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            } else {
                const words = await getAllWords();
                const index = words.findIndex(w => w.id === id);
                if (index !== -1) {
                    words[index] = { ...words[index], ...wordData };
                    localStorage.setItem(LS_KEY, JSON.stringify(words));
                }
            }
        }

        async function deleteWord(id) {
            if (useIndexedDB) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORE_NAME, 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            } else {
                const words = await getAllWords();
                const filtered = words.filter(w => w.id !== id);
                localStorage.setItem(LS_KEY, JSON.stringify(filtered));
            }
        }

        // ==================== DOM ====================
        const DOM = {
            wordInput: document.getElementById('wordInput'),
            meaningInput: document.getElementById('meaningInput'),
            exampleInput: document.getElementById('exampleInput'),
            categorySearch: document.getElementById('categorySearch'),
            imageContainer: document.getElementById('imageContainer'),
            addImageBtn: document.getElementById('addImageBtn'),
            imageInput: document.getElementById('imageInput'),
            saveWordBtn: document.getElementById('saveWordBtn'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            editId: document.getElementById('editId'),
            globalSearchInput: document.getElementById('globalSearchInput'),
            searchBtn: document.getElementById('searchBtn'),
            wordList: document.getElementById('wordList'),
            startStudyBtn: document.getElementById('startStudyBtn'),
            studyMode: document.getElementById('studyMode'),
            studyWord: document.getElementById('studyWord'),
            studyMeaning: document.getElementById('studyMeaning'),
            studyExample: document.getElementById('studyExample'),
            studyImages: document.getElementById('studyImages'),
            showMeaningBtn: document.getElementById('showMeaningBtn'),
            nextBtn: document.getElementById('nextBtn'),
            prevBtn: document.getElementById('prevBtn'),
            exportExcelBtn: document.getElementById('exportExcelBtn'),
            importExcelBtn: document.getElementById('importExcelBtn'),
            fileImportInput: document.getElementById('fileImportInput'),
            qrcodeBtn: document.getElementById('qrcodeBtn'),
            qrcodeModal: document.getElementById('qrcodeModal'),
            qrcodeContainer: document.getElementById('qrcode-container'),
            closeQrcodeBtn: document.getElementById('closeQrcodeBtn')
        };

        const studyState = { words: [], index: 0 };

        // ==================== å›¾ç‰‡å¤„ç†ï¼ˆæ”¯æŒç²˜è´´ï¼‰ ====================
        function createImageItem(src) {
            const div = document.createElement('div');
            div.className = 'image-item';
            if (src) {
                const img = document.createElement('img');
                img.src = src;
                img.alt = 'å•è¯å›¾ç‰‡';
                div.appendChild(img);
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-img';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.onclick = () => div.remove();
                div.appendChild(removeBtn);
            } else {
                div.textContent = '+';
            }
            return div;
        }

        function addImageToContainer(base64) {
            const item = createImageItem(base64);
            DOM.imageContainer.insertBefore(item, DOM.addImageBtn.nextElementSibling || null);
        }

        DOM.imageContainer.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (ev) => addImageToContainer(ev.target.result);
                    reader.readAsDataURL(blob);
                }
            }
        });

        function previewImages(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (e) => addImageToContainer(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        // ==================== æ¸²æŸ“ä¸æœç´¢ ====================
        async function renderWordList(words) {
            DOM.wordList.innerHTML = '';
            if (words.length === 0) {
                DOM.wordList.innerHTML = '<li style="text-align:center;color:#999;padding:20px;">æš‚æ— å•è¯ï¼Œèµ¶ç´§æ·»åŠ å§ï¼</li>';
                return;
            }
            words.forEach(item => {
                const categories = item.categories || [];
                const categoryText = categories.length > 0 ? categories.join('ã€') : 'æ— ç±»åˆ«';
                const li = document.createElement('li');
                li.className = 'word-item';
                li.dataset.id = item.id;
                li.innerHTML = `
                    <div class="word-header">
                        <span class="word-main">${item.word || 'æœªçŸ¥å•è¯'}</span>
                        <span class="word-category">${categoryText}</span>
                    </div>
                    <div class="word-meaning"><strong>é‡Šä¹‰ï¼š</strong>${item.meaning || 'æ— é‡Šä¹‰'}</div>
                    ${item.examples && item.examples.length ? `<div class="word-example"><strong>ä¾‹å¥ï¼š</strong>${item.examples.join('<br>')}</div>` : ''}
                    ${item.images && item.images.length > 0 ? `
                        <div class="word-images">
                            ${item.images.map(src => `<img src="${src}" alt="${item.word}" />`).join('')}
                        </div>` : ''}
                    <div class="word-actions">
                        <button class="edit-btn primary" data-id="${item.id}">ç¼–è¾‘</button>
                        <button class="delete-btn danger" data-id="${item.id}">åˆ é™¤</button>
                    </div>
                `;
                DOM.wordList.appendChild(li);
            });
        }

        function globalSearch(words, keyword) {
            const lower = keyword.toLowerCase().trim();
            if (!lower) return words;
            return words.filter(word =>
                (word.word?.toLowerCase().includes(lower)) ||
                (word.meaning?.toLowerCase().includes(lower)) ||
                (word.examples?.some(ex => ex.toLowerCase().includes(lower))) ||
                (word.categories?.some(cat => cat.toLowerCase().includes(lower)))
            );
        }

        function resetForm() {
            DOM.editId.value = '';
            DOM.wordInput.value = '';
            DOM.meaningInput.value = '';
            DOM.exampleInput.value = '';
            DOM.categorySearch.value = '';
            DOM.imageContainer.querySelectorAll('.image-item:not(#addImageBtn)').forEach(el => el.remove());
            DOM.cancelEditBtn.style.display = 'none';
            DOM.saveWordBtn.textContent = 'ğŸ’¾ ä¿å­˜';
        }

        async function loadWords() {
            const words = await getAllWords();
            renderWordList(words);
        }

        // ==================== åˆå§‹åŒ– ====================
        async function initApp() {
            if (!useIndexedDB) {
                console.log('æœ¬åœ°æ–‡ä»¶æ¨¡å¼ï¼šä½¿ç”¨ localStorage å­˜å‚¨');
            }
            await loadWords();

            // å›¾ç‰‡ä¸Šä¼ 
            DOM.addImageBtn.addEventListener('click', () => DOM.imageInput.click());
            DOM.imageInput.addEventListener('change', () => previewImages(DOM.imageInput.files));
            DOM.imageContainer.focus();

            // ä¿å­˜å•è¯
            DOM.saveWordBtn.addEventListener('click', async () => {
                const word = DOM.wordInput.value.trim();
                const meaning = DOM.meaningInput.value.trim();
                const examples = DOM.exampleInput.value.trim() ? DOM.exampleInput.value.trim().split('\n') : [];
                const categories = DOM.categorySearch.value.trim() ? DOM.categorySearch.value.split(',').map(c => c.trim()).filter(Boolean) : [];
                const images = Array.from(DOM.imageContainer.querySelectorAll('.image-item:not(#addImageBtn) img')).map(img => img.src);

                if (!word || !meaning) {
                    alert('å•è¯å’Œé‡Šä¹‰ä¸èƒ½ä¸ºç©ºï¼');
                    return;
                }

                const wordData = { word, meaning, examples, categories, images };

                try {
                    if (DOM.editId.value) {
                        await updateWord(Number(DOM.editId.value), wordData);
                        alert('âœ… æ›´æ–°æˆåŠŸï¼');
                    } else {
                        await addWord(wordData);
                        alert('âœ… æ·»åŠ æˆåŠŸï¼');
                    }
                    resetForm();
                    await loadWords();
                } catch (err) {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
                }
            });

            DOM.cancelEditBtn.addEventListener('click', resetForm);

            // ç¼–è¾‘ä¸åˆ é™¤
            DOM.wordList.addEventListener('click', async (e) => {
                const target = e.target;
                const btn = target.closest('button');
                if (!btn) return;
                const id = Number(btn.dataset.id);
                if (!id) return;

                if (btn.classList.contains('edit-btn')) {
                    const words = await getAllWords();
                    const word = words.find(w => w.id === id);
                    if (!word) return alert('å•è¯ä¸å­˜åœ¨');

                    DOM.editId.value = word.id;
                    DOM.wordInput.value = word.word || '';
                    DOM.meaningInput.value = word.meaning || '';
                    DOM.exampleInput.value = word.examples?.join('\n') || '';
                    DOM.categorySearch.value = word.categories?.join(', ') || '';
                    DOM.imageContainer.querySelectorAll('.image-item:not(#addImageBtn)').forEach(el => el.remove());
                    word.images?.forEach(src => {
                        const item = createImageItem(src);
                        DOM.imageContainer.insertBefore(item, DOM.addImageBtn.nextElementSibling || null);
                    });

                    DOM.cancelEditBtn.style.display = 'inline-block';
                    DOM.saveWordBtn.textContent = 'âœï¸ æ›´æ–°';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                if (btn.classList.contains('delete-btn')) {
                    if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªå•è¯å—ï¼Ÿ')) return;
                    await deleteWord(id);
                    await loadWords();
                    alert('âœ… åˆ é™¤æˆåŠŸï¼');
                }
            });

            // æœç´¢
            DOM.searchBtn.addEventListener('click', async () => {
                const keyword = DOM.globalSearchInput.value;
                const allWords = await getAllWords();
                const results = globalSearch(allWords, keyword);
                renderWordList(results);
            });

            // å­¦ä¹ æ¨¡å¼
            DOM.startStudyBtn.addEventListener('click', async () => {
                studyState.words = await getAllWords();
                if (studyState.words.length === 0) return alert('è¿˜æ²¡æœ‰å•è¯ï¼');
                studyState.index = 0;
                DOM.studyMode.style.display = 'block';
                showCurrentStudyCard();
            });

            function showCurrentStudyCard() {
                const word = studyState.words[studyState.index];
                DOM.studyWord.textContent = word.word || '';
                DOM.studyMeaning.textContent = word.meaning || '';
                DOM.studyExample.textContent = word.examples?.[0] || '';
                DOM.studyImages.innerHTML = (word.images || []).slice(0, 3).map(src => `<img src="${src}" alt="${word.word}" />`).join('');
                DOM.studyMeaning.style.display = 'none';
                DOM.studyExample.style.display = 'none';
                DOM.studyImages.style.display = 'none';
                DOM.showMeaningBtn.textContent = 'ğŸ‘€ æ˜¾ç¤ºæ„æ€';
            }

            DOM.nextBtn.addEventListener('click', () => {
                studyState.index = (studyState.index + 1) % studyState.words.length;
                showCurrentStudyCard();
            });

            DOM.prevBtn.addEventListener('click', () => {
                studyState.index = (studyState.index - 1 + studyState.words.length) % studyState.words.length;
                showCurrentStudyCard();
            });

            DOM.showMeaningBtn.addEventListener('click', () => {
                const hidden = DOM.studyMeaning.style.display === 'none';
                DOM.studyMeaning.style.display = hidden ? 'block' : 'none';
                DOM.studyExample.style.display = hidden ? 'block' : 'none';
                DOM.studyImages.style.display = hidden ? 'flex' : 'none';
                DOM.showMeaningBtn.textContent = hidden ? 'ğŸ™ˆ éšè—æ„æ€' : 'ğŸ‘€ æ˜¾ç¤ºæ„æ€';
            });

            // Excel å¯¼å‡º
            DOM.exportExcelBtn.addEventListener('click', async () => {
                const words = await getAllWords();
                if (words.length === 0) return alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                const wsData = [['ID', 'å•è¯', 'é‡Šä¹‰', 'ä¾‹å¥', 'ç±»åˆ«', 'å›¾ç‰‡æ•°é‡']];
                words.forEach(w => {
                    wsData.push([
                        w.id,
                        w.word || '',
                        w.meaning || '',
                        w.examples?.join('; ') || '',
                        w.categories?.join(', ') || '',
                        w.images?.length || 0
                    ]);
                });
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                ws['!cols'] = [{ wch: 5 }, { wch: 20 }, { wch: 30 }, { wch: 40 }, { wch: 20 }, { wch: 10 }];
                XLSX.utils.book_append_sheet(wb, ws, 'å•è¯è¡¨');
                XLSX.writeFile(wb, `æˆ‘çš„å•è¯æœ¬_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
            });

            // Excel å¯¼å…¥
            DOM.importExcelBtn.addEventListener('click', () => DOM.fileImportInput.click());
            DOM.fileImportInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const data = evt.target.result;
                        const wb = XLSX.read(data, { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(ws);
                        let added = 0;
                        for (const row of jsonData) {
                            const word = row['å•è¯'] || row['Word'] || '';
                            const meaning = row['é‡Šä¹‰'] || row['Meaning'] || '';
                            if (!word || !meaning) continue;
                            const examples = String(row['ä¾‹å¥'] || '').split(';').map(s => s.trim()).filter(Boolean);
                            const categories = String(row['ç±»åˆ«'] || '').split(',').map(s => s.trim()).filter(Boolean);
                            const images = String(row['å›¾ç‰‡é“¾æ¥'] || row['å›¾ç‰‡'] || '').split(';').map(s => s.trim()).filter(Boolean);
                            await addWord({ word, meaning, examples, categories, images });
                            added++;
                        }
                        alert(`âœ… æˆåŠŸå¯¼å…¥ ${added} ä¸ªå•è¯ï¼`);
                        await loadWords();
                    } catch (err) {
                        alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            // äºŒç»´ç 
            DOM.qrcodeBtn.addEventListener('click', () => {
                const currentUrl = window.location.href.split('?')[0].replace(/#.*$/, '');
                DOM.qrcodeContainer.innerHTML = '';
                new QRCode(DOM.qrcodeContainer, {
                    text: currentUrl,
                    width: 256,
                    height: 256,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                DOM.qrcodeModal.style.display = 'flex';
            });

            DOM.closeQrcodeBtn.addEventListener('click', () => DOM.qrcodeModal.style.display = 'none');
            DOM.qrcodeModal.addEventListener('click', (e) => {
                if (e.target === DOM.qrcodeModal) DOM.qrcodeModal.style.display = 'none';
            });
        }

        window.addEventListener('load', initApp);
    </script>
</body>
</html>
