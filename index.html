<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ğŸ“˜ æˆ‘çš„å•è¯æœ¬ - äº‘åŒæ­¥ç‰ˆï¼ˆLeanCloudï¼‰</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fdfdfd;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        .form-row label {
            width: 80px;
            font-weight: 600;
            font-size: 14px;
        }
        input[type="text"], textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        textarea { height: 60px; resize: vertical; }
        .image-upload {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: start;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #fafafa;
            min-height: 100px;
        }
        .image-upload:focus-within {
            border-color: #3498db;
            background: #f0f8ff;
        }
        .image-item {
            position: relative;
            width: 80px;
            height: 80px;
            border: 1px dashed #ccc;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fff;
            font-size: 24px;
            color: #aaa;
            cursor: pointer;
        }
        .image-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .image-item .remove-img {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .paste-hint {
            font-size: 12px;
            color: #999;
            text-align: center;
            width: 100%;
            margin-top: 5px;
        }
        .global-search-box {
            margin: 20px 0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        #globalSearchInput {
            width: 100%;
            max-width: 500px;
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .search-btn {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .search-btn:hover { background-color: #2980b9; }
        .main-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button.primary { background-color: #3498db; color: white; }
        button.primary:hover { background-color: #2980b9; }
        button.success { background-color: #2ecc71; color: white; }
        button.success:hover { background-color: #27ae60; }
        button.warning { background-color: #f39c12; color: white; }
        button.warning:hover { background-color: #e67e22; }
        button.danger { background-color: #e74c3c; color: white; }
        button.danger:hover { background-color: #c0392b; }
        .word-list { list-style: none; padding: 0; }
        .word-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            border-radius: 8px;
            background: #fcfcfc;
            position: relative;
            transition: background-color 0.2s;
        }
        .word-item:hover { background: #f5f9ff; }
        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .word-main { font-weight: bold; color: #2c3e50; font-size: 18px; }
        .word-category {
            display: inline-block;
            padding: 4px 10px;
            background-color: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .word-meaning { font-size: 15px; color: #34495e; margin-bottom: 8px; line-height: 1.5; }
        .word-example { font-size: 14px; color: #555; font-style: italic; padding-left: 10px; border-left: 2px solid #3498db; margin-bottom: 8px; line-height: 1.5; }
        .word-images { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
        .word-images img { max-height: 80px; border-radius: 6px; object-fit: contain; }
        .word-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }
        .word-actions button { padding: 5px 10px; font-size: 12px; }
        .study-mode {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f0f5ff;
            border-radius: 10px;
        }
        #studyWord { font-size: 36px; margin: 20px 0; color: #2c3e50; min-height: 50px; }
        #studyImages { margin: 20px auto; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        #studyImages img { max-height: 150px; border-radius: 8px; object-fit: contain; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .study-info { margin-top: 15px; line-height: 1.6; }
        #studyMeaning, #studyExample { display: none; font-size: 18px; color: #27ae60; }
        #studyExample { font-style: italic; color: #555; margin-top: 10px; }
        .study-controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }
        #qrcode-container {
            width: 256px;
            height: 256px;
            margin: 0 auto 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .close-modal { margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .func-bar { display: flex; justify-content: flex-end; align-items: center; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“˜ æˆ‘çš„å•è¯æœ¬ï¼ˆLeanCloud äº‘åŒæ­¥ç‰ˆï¼‰</h1>
        
        <div class="form-section">
            <h2 style="margin:0 0 10px;">ğŸ“ æ·»åŠ æ–°å•è¯</h2>
            <input type="hidden" id="editId" value="" />
            <div class="form-row">
                <label for="wordInput">å•è¯</label>
                <input type="text" id="wordInput" placeholder="è¾“å…¥è‹±æ–‡å•è¯/çŸ­è¯­" />
            </div>
            <div class="form-row">
                <label for="meaningInput">é‡Šä¹‰</label>
                <input type="text" id="meaningInput" placeholder="è¾“å…¥ä¸­æ–‡æ„æ€" />
            </div>
            <div class="form-row">
                <label for="exampleInput">ä¾‹å¥</label>
                <textarea id="exampleInput" placeholder="è¾“å…¥è‹±æ–‡ä¾‹å¥ï¼Œå¯æ¢è¡Œ"></textarea>
            </div>
            <div class="form-row">
                <label>ç±»åˆ«</label>
                <div style="flex:1;">
                    <div class="category-search">
                        <input type="text" id="categorySearch" placeholder="è¾“å…¥ç±»åˆ«ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰" />
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label>å›¾ç‰‡</label>
                <div class="image-upload" id="imageContainer" tabindex="0">
                    <div class="image-item" id="addImageBtn">+</div>
                    <div class="paste-hint">ğŸ’¡ æç¤ºï¼šç‚¹å‡»â€œ+â€ä¸Šä¼  æˆ– ç›´æ¥åœ¨æ­¤åŒºåŸŸæŒ‰ Ctrl+V ç²˜è´´å›¾ç‰‡</div>
                    <input type="file" id="imageInput" accept="image/*" multiple style="display:none;" />
                </div>
            </div>
            <div class="form-row" style="justify-content:flex-end;">
                <button id="cancelEditBtn" style="display:none; margin-right:10px;">å–æ¶ˆ</button>
                <button id="saveWordBtn" class="primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>

        <div class="func-bar">
            <button id="qrcodeBtn" class="primary">ğŸ“± ç”ŸæˆäºŒç»´ç </button>
        </div>

        <div class="global-search-box">
            <input type="text" id="globalSearchInput" placeholder="æœç´¢å•è¯/é‡Šä¹‰/ä¾‹å¥/ç±»åˆ«..." />
            <button id="searchBtn" class="search-btn">ğŸ” æœç´¢</button>
        </div>

        <div class="main-buttons">
            <button id="startStudyBtn" class="primary">ğŸ® å¼€å§‹èƒŒè¯µ</button>
            <button id="exportExcelBtn" class="success">ğŸ“¤ å¯¼å‡ºä¸º Excel</button>
            <button id="importExcelBtn" class="warning">ğŸ“¥ ä» Excel å¯¼å…¥</button>
        </div>

        <div class="study-mode" id="studyMode" style="display:none;">
            <p id="studyWord">ç‚¹å‡»â€œä¸‹ä¸€ä¸ªâ€å¼€å§‹</p>
            <div id="studyImages"></div>
            <div class="study-info">
                <p id="studyMeaning"></p>
                <p id="studyExample"></p>
            </div>
            <div class="study-controls">
                <button id="prevBtn" class="primary">â¬…ï¸ ä¸Šä¸€ä¸ª</button>
                <button id="showMeaningBtn" class="warning">ğŸ‘€ æ˜¾ç¤ºæ„æ€</button>
                <button id="nextBtn" class="primary">ä¸‹ä¸€ä¸ª â¡ï¸</button>
            </div>
        </div>

        <ul id="wordList" class="word-list"></ul>

        <input type="file" id="fileImportInput" accept=".xlsx,.xls" style="display:none;" />
    </div>

    <div class="modal" id="qrcodeModal">
        <div class="modal-content">
            <h3>æ‰«ç å­¦ä¹ </h3>
            <div id="qrcode-container"></div>
            <p>æ‰‹æœºæ‰«ç åŒæ­¥å­¦ä¹ </p>
            <button class="close-modal" id="closeQrcodeBtn">å…³é—­</button>
        </div>
    </div>

    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.3/dist/av-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // ==================== LeanCloud åˆå§‹åŒ– ====================
        const APP_ID = 'BYTejo5oZ9HbyH1aUzGppRg2-gzGzoHsz';
        const APP_KEY = 'KSOa17ZVMcck81n9905e63l8';  // æ‚¨çš„ App Key
AV.init({
    appId: APP_ID,
    appKey: APP_KEY,
    serverURL: 'https://api.leancloud.cn'
});
        console.log('LeanCloud åˆå§‹åŒ–æˆåŠŸï¼Œä½¿ç”¨ Master Key');
        const Word = AV.Object.extend('Word');

        // ==================== äº‘ç«¯å›¾ç‰‡ä¸Šä¼  ====================
        async function uploadImages(base64List) {
            if (!base64List || base64List.length === 0) return [];
            const promises = base64List.map(async (base64) => {
                try {
                    if (!base64 || !base64.startsWith('data:')) return '';
                    const [, data] = base64.split(',');
                    const bytes = atob(data);
                    const array = new Uint8Array(bytes.length);
                    for (let i = 0; i < bytes.length; i++) array[i] = bytes.charCodeAt(i);
                    const blob = new Blob([array], { type: 'image/jpeg' });
                    const name = `image_${Date.now()}_${Math.random().toString(36).substr(2)}.jpg`;
                    const file = new AV.File(name, blob);
                    const uploaded = await file.save();
                    return uploaded.url();
                } catch (err) {
                    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', err);
                    return '';
                }
            });
            return Promise.all(promises);
        }

        // ==================== äº‘å­˜å‚¨æ“ä½œ ====================
        async function getAllWords() {
            const query = new AV.Query('Word');
            query.descending('createdAt');
            try {
                const results = await query.find();
                return results.map(obj => ({
                    id: obj.id,
                    word: obj.get('word') || '',
                    meaning: obj.get('meaning') || '',
                    examples: obj.get('examples') || [],
                    categories: obj.get('categories') || [],
                    images: obj.get('images') || []
                }));
            } catch (err) {
                console.error('è·å–å•è¯å¤±è´¥', err);
                alert('åŠ è½½å•è¯å¤±è´¥ï¼š' + err.message);
                return [];
            }
        }

        async function addWord(data, images) {
            const urls = await uploadImages(images);
            const obj = new Word();
            obj.set({ ...data, images: urls.filter(url => url) });
            await obj.save();
        }

        async function updateWord(id, data, newImages) {
            const obj = AV.Object.createWithoutData('Word', id);
            obj.set(data);
            if (newImages.length > 0) {
                const newUrls = await uploadImages(newImages);
                const oldUrls = obj.get('images') || [];
                obj.set('images', oldUrls.concat(newUrls.filter(url => url)));
            }
            await obj.save();
        }

        async function deleteWord(id) {
            try {
                const obj = AV.Object.createWithoutData('Word', id);
                await obj.destroy();
            } catch (err) {
                console.error('åˆ é™¤å¤±è´¥', err);
                throw err;
            }
        }

        // ==================== DOM ====================
        const DOM = {
            wordInput: document.getElementById('wordInput'),
            meaningInput: document.getElementById('meaningInput'),
            exampleInput: document.getElementById('exampleInput'),
            categorySearch: document.getElementById('categorySearch'),
            imageContainer: document.getElementById('imageContainer'),
            addImageBtn: document.getElementById('addImageBtn'),
            imageInput: document.getElementById('imageInput'),
            saveWordBtn: document.getElementById('saveWordBtn'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            editId: document.getElementById('editId'),
            globalSearchInput: document.getElementById('globalSearchInput'),
            searchBtn: document.getElementById('searchBtn'),
            wordList: document.getElementById('wordList'),
            startStudyBtn: document.getElementById('startStudyBtn'),
            studyMode: document.getElementById('studyMode'),
            studyWord: document.getElementById('studyWord'),
            studyMeaning: document.getElementById('studyMeaning'),
            studyExample: document.getElementById('studyExample'),
            studyImages: document.getElementById('studyImages'),
            showMeaningBtn: document.getElementById('showMeaningBtn'),
            nextBtn: document.getElementById('nextBtn'),
            prevBtn: document.getElementById('prevBtn'),
            exportExcelBtn: document.getElementById('exportExcelBtn'),
            importExcelBtn: document.getElementById('importExcelBtn'),
            fileImportInput: document.getElementById('fileImportInput'),
            qrcodeBtn: document.getElementById('qrcodeBtn'),
            qrcodeModal: document.getElementById('qrcodeModal'),
            qrcodeContainer: document.getElementById('qrcode-container'),
            closeQrcodeBtn: document.getElementById('closeQrcodeBtn')
        };

        const studyState = { words: [], index: 0 };

        // ==================== å›¾ç‰‡å¤„ç† ====================
        function createImageItem(src) {
            const div = document.createElement('div');
            div.className = 'image-item';
            if (src) {
                const img = document.createElement('img');
                img.src = src;
                div.appendChild(img);
                const remove = document.createElement('button');
                remove.className = 'remove-img';
                remove.innerHTML = 'Ã—';
                remove.onclick = () => div.remove();
                div.appendChild(remove);
            } else {
                div.textContent = '+';
            }
            return div;
        }

        function addPreviewImage(src) {
            const item = createImageItem(src);
            DOM.imageContainer.insertBefore(item, DOM.addImageBtn.nextElementSibling || null);
        }

        DOM.imageContainer.addEventListener('paste', e => {
            for (let item of e.clipboardData.items) {
                if (item.type.includes('image')) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = ev => addPreviewImage(ev.target.result);
                    reader.readAsDataURL(file);
                }
            }
        });

        DOM.addImageBtn.onclick = () => DOM.imageInput.click();
        DOM.imageInput.onchange = () => {
            Array.from(DOM.imageInput.files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = e => addPreviewImage(e.target.result);
                    reader.readAsDataURL(file);
                }
            });
        };

        // ==================== æ¸²æŸ“ä¸æœç´¢ ====================
        async function renderWordList(words) {
            DOM.wordList.innerHTML = '';
            if (words.length === 0) {
                DOM.wordList.innerHTML = '<li style="text-align:center;color:#999;padding:20px;">æš‚æ— å•è¯ï¼Œèµ¶ç´§æ·»åŠ å§ï¼</li>';
                return;
            }
            words.forEach(item => {
                const categoryText = item.categories.length ? item.categories.join('ã€') : 'æ— ç±»åˆ«';
                const li = document.createElement('li');
                li.className = 'word-item';
                li.dataset.id = item.id;
                li.innerHTML = `
                    <div class="word-header">
                        <span class="word-main">${item.word}</span>
                        <span class="word-category">${categoryText}</span>
                    </div>
                    <div class="word-meaning"><strong>é‡Šä¹‰ï¼š</strong>${item.meaning}</div>
                    ${item.examples.length ? `<div class="word-example"><strong>ä¾‹å¥ï¼š</strong>${item.examples.join('<br>')}</div>` : ''}
                    ${item.images.length ? `
                        <div class="word-images">
                            ${item.images.map(src => `<img src="${src}" alt="å›¾ç‰‡" />`).join('')}
                        </div>` : ''}
                    <div class="word-actions">
                        <button class="edit-btn primary" data-id="${item.id}">ç¼–è¾‘</button>
                        <button class="delete-btn danger" data-id="${item.id}">åˆ é™¤</button>
                    </div>
                `;
                DOM.wordList.appendChild(li);
            });
        }

        function globalSearch(words, keyword) {
            const lower = keyword.toLowerCase().trim();
            if (!lower) return words;
            return words.filter(w =>
                w.word.toLowerCase().includes(lower) ||
                w.meaning.toLowerCase().includes(lower) ||
                w.examples.some(e => e.toLowerCase().includes(lower)) ||
                w.categories.some(c => c.toLowerCase().includes(lower))
            );
        }

        function resetForm() {
            DOM.editId.value = '';
            DOM.wordInput.value = '';
            DOM.meaningInput.value = '';
            DOM.exampleInput.value = '';
            DOM.categorySearch.value = '';
            DOM.imageContainer.querySelectorAll('.image-item:not(#addImageBtn)').forEach(el => el.remove());
            DOM.cancelEditBtn.style.display = 'none';
            DOM.saveWordBtn.textContent = 'ğŸ’¾ ä¿å­˜';
            DOM.saveWordBtn.disabled = false;
        }

        async function loadWords() {
            const words = await getAllWords();
            renderWordList(words);
        }

        // ==================== åˆå§‹åŒ–ä¸äº‹ä»¶ ====================
        async function initApp() {
            await loadWords();

            DOM.saveWordBtn.onclick = async () => {
                DOM.saveWordBtn.disabled = true;
                DOM.saveWordBtn.textContent = 'ä¿å­˜ä¸­...';

                const word = DOM.wordInput.value.trim();
                const meaning = DOM.meaningInput.value.trim();
                const examples = DOM.exampleInput.value.trim() ? DOM.exampleInput.value.trim().split('\n') : [];
                const categories = DOM.categorySearch.value.trim() ? DOM.categorySearch.value.split(',').map(c => c.trim()).filter(Boolean) : [];
                const images = Array.from(DOM.imageContainer.querySelectorAll('.image-item:not(#addImageBtn) img')).map(img => img.src);

                if (!word || !meaning) {
                    alert('å•è¯å’Œé‡Šä¹‰ä¸èƒ½ä¸ºç©ºï¼');
                    DOM.saveWordBtn.disabled = false;
                    DOM.saveWordBtn.textContent = 'ğŸ’¾ ä¿å­˜';
                    return;
                }

                const data = { word, meaning, examples, categories };

                try {
                    if (DOM.editId.value) {
                        await updateWord(DOM.editId.value, data, images);
                        alert('âœ… æ›´æ–°æˆåŠŸï¼');
                    } else {
                        await addWord(data, images);
                        alert('âœ… æ·»åŠ æˆåŠŸï¼');
                    }
                    resetForm();
                    await loadWords();
                } catch (err) {
                    console.error('ä¿å­˜å¤±è´¥', err);
                    alert('ä¿å­˜å¤±è´¥ï¼š' + (err.message || 'è¯·æ£€æŸ¥ç½‘ç»œæˆ–æ§åˆ¶å°é”™è¯¯'));
                } finally {
                    DOM.saveWordBtn.disabled = false;
                    DOM.saveWordBtn.textContent = 'ğŸ’¾ ä¿å­˜';
                }
            };

            DOM.cancelEditBtn.onclick = resetForm;

            DOM.wordList.onclick = async e => {
                const btn = e.target;
                const id = btn.dataset.id;
                if (!id) return;

                if (btn.classList.contains('edit-btn')) {
                    const words = await getAllWords();
                    const word = words.find(w => w.id === id);
                    if (!word) return;

                    DOM.editId.value = word.id;
                    DOM.wordInput.value = word.word;
                    DOM.meaningInput.value = word.meaning;
                    DOM.exampleInput.value = word.examples.join('\n');
                    DOM.categorySearch.value = word.categories.join(', ');
                    DOM.imageContainer.querySelectorAll('.image-item:not(#addImageBtn)').forEach(el => el.remove());
                    word.images.forEach(src => addPreviewImage(src));

                    DOM.cancelEditBtn.style.display = 'inline-block';
                    DOM.saveWordBtn.textContent = 'âœï¸ æ›´æ–°';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                if (btn.classList.contains('delete-btn')) {
                    if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªå•è¯å—ï¼Ÿ')) return;
                    try {
                        await deleteWord(id);
                        await loadWords();
                        alert('âœ… åˆ é™¤æˆåŠŸï¼');
                    } catch (err) {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + err.message);
                    }
                }
            };

            DOM.searchBtn.onclick = async () => {
                const kw = DOM.globalSearchInput.value;
                const all = await getAllWords();
                renderWordList(globalSearch(all, kw));
            };

            DOM.startStudyBtn.onclick = async () => {
                studyState.words = await getAllWords();
                if (studyState.words.length === 0) return alert('æš‚æ— å•è¯');
                studyState.index = 0;
                DOM.studyMode.style.display = 'block';
                showCard();
            };

            function showCard() {
                const w = studyState.words[studyState.index];
                DOM.studyWord.textContent = w.word;
                DOM.studyMeaning.textContent = w.meaning;
                DOM.studyExample.textContent = w.examples[0] || '';
                DOM.studyImages.innerHTML = w.images.slice(0, 3).map(src => `<img src="${src}" />`).join('');
                DOM.studyMeaning.style.display = 'none';
                DOM.studyExample.style.display = 'none';
                DOM.studyImages.style.display = 'none';
                DOM.showMeaningBtn.textContent = 'ğŸ‘€ æ˜¾ç¤ºæ„æ€';
            }

            DOM.nextBtn.onclick = () => { studyState.index = (studyState.index + 1) % studyState.words.length; showCard(); };
            DOM.prevBtn.onclick = () => { studyState.index = (studyState.index - 1 + studyState.words.length) % studyState.words.length; showCard(); };
            DOM.showMeaningBtn.onclick = () => {
                const hidden = DOM.studyMeaning.style.display === 'none';
                DOM.studyMeaning.style.display = hidden ? 'block' : 'none';
                DOM.studyExample.style.display = hidden ? 'block' : 'none';
                DOM.studyImages.style.display = hidden ? 'flex' : 'none';
                DOM.showMeaningBtn.textContent = hidden ? 'ğŸ™ˆ éšè—æ„æ€' : 'ğŸ‘€ æ˜¾ç¤ºæ„æ€';
            };

            DOM.exportExcelBtn.onclick = async () => {
                const words = await getAllWords();
                if (words.length === 0) return alert('æ— æ•°æ®');
                const data = [['å•è¯', 'é‡Šä¹‰', 'ä¾‹å¥', 'ç±»åˆ«', 'å›¾ç‰‡æ•°é‡']];
                words.forEach(w => data.push([w.word, w.meaning, w.examples.join('; '), w.categories.join(', '), w.images.length]));
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'å•è¯è¡¨');
                XLSX.writeFile(wb, `å•è¯æœ¬_${new Date().toLocaleDateString()}.xlsx`);
            };

            DOM.importExcelBtn.onclick = () => DOM.fileImportInput.click();
            DOM.fileImportInput.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async ev => {
                    try {
                        const wb = XLSX.read(ev.target.result, { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(ws);
                        let count = 0;
                        for (const row of rows) {
                            const word = row['å•è¯'] || row['Word'] || '';
                            const meaning = row['é‡Šä¹‰'] || row['Meaning'] || '';
                            if (!word || !meaning) continue;
                            const examples = String(row['ä¾‹å¥'] || '').split(';').map(s => s.trim()).filter(Boolean);
                            const categories = String(row['ç±»åˆ«'] || '').split(',').map(s => s.trim()).filter(Boolean);
                            await addWord({ word, meaning, examples, categories }, []);
                            count++;
                        }
                        alert(`æˆåŠŸå¯¼å…¥ ${count} ä¸ªå•è¯`);
                        await loadWords();
                    } catch (err) {
                        alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            DOM.qrcodeBtn.onclick = () => {
                const url = location.href.split('?')[0].replace(/#.*$/, '');
                DOM.qrcodeContainer.innerHTML = '';
                new QRCode(DOM.qrcodeContainer, { text: url, width: 256, height: 256, correctLevel: QRCode.CorrectLevel.H });
                DOM.qrcodeModal.style.display = 'flex';
            };
            DOM.closeQrcodeBtn.onclick = () => DOM.qrcodeModal.style.display = 'none';
            DOM.qrcodeModal.onclick = e => { if (e.target === DOM.qrcodeModal) DOM.qrcodeModal.style.display = 'none'; };
        }

        window.onload = initApp;
    </script>
</body>
</html>